// Start Restaurant app
// Using Angular.js


// var app2 = angular.module("sampleApp", ["firebase"]);
// app2.controller("SampleCtrl", function($scope, $firebaseArray) {
//   var ref = firebase.database().ref();
//   var list = $firebaseArray(ref);
//
//   console.log(list);
// });

// Angular setup
// Define 'phonecatApp' module
var app = angular.module('myRestaurantApp', ['ngRoute', 'firebase', 'ngFacebook']);

app.run( function( $rootScope ) {
  // Load the facebook SDK asynchronously
  (function(){
     // If we've already installed the SDK, we're done
     if (document.getElementById('facebook-jssdk')) {return;}

     // Get the first script element, which we'll use to find the parent node
     var firstScriptElement = document.getElementsByTagName('script')[0];

     // Create a new script element and set its id
     var facebookJS = document.createElement('script');
     facebookJS.id = 'facebook-jssdk';

     // Set the new script's source to the source of the Facebook JS SDK
     facebookJS.src = 'https://connect.facebook.net/en_US/all.js';

     // Insert the Facebook JS SDK into the DOM
     firstScriptElement.parentNode.insertBefore(facebookJS, firstScriptElement);
   }());
});

/*
This directive allows us to pass a function in on an enter key to do what we want.
 */
// app.directive('ngEnter', function () {
//     return function (scope, element, attrs) {
//         element.bind("keydown keypress", function (event) {
//             if(event.which === 13) {
//                 scope.$apply(function (){
//                     scope.$eval(attrs.ngEnter);
//                 });
//
//                 event.preventDefault();
//             }
//         });
//     };
// });

// Define RestrController
// app.controller('myController', function myController($scope, $routeParams, message) {
//
//   $scope.bird = "Nerd";
//   $scope.sayHello = function () {
//     // alert("Hello, world!");
//     console.log("You clicked me");
//     return "Bird";
//   }
//
//
//
// });
//
//
//
// app.filter("searchquery", function(localizationService) {
//
//   function localization(value) {
//
//     if (localizationService.text && localizationService.text.hasOwnProperty(value)) {
//       return localizationService.text[value];
//     }
//     return value;
//   }
//
//   localization.$stateful = true;
//
//   return localization;
// });

// App-2 for installing ServiceWorker

if (navigator.serviceWorker) {
    navigator.serviceWorker.register('sw.js', {
      scope: '.'
    }).then(function(registration) {
      console.log('The service worker has been registered ', registration);
    });
}
// Define 'AvatarImgController' controller
app.controller('AvatarImgController', ['$scope', '$location', 'hexafy', '$facebook', function AvatarImgController($scope, $location, hexafy, $facebook) {
  // $scope.pagelink = function () {
  //   if ($scope.isLoggedIn == false) {
  //     $location.path("/login");
  //   } else {
  //     console.log("You clicked 'signed out.'");
  //     $location.path("/logout");
  //   }
  // };
  // $scope.url = hexfy.getAvatar();

  $scope.url = "img/avatar/blank.png";
  $scope.usrName = "";

  $scope.getUrl = hexafy.getUrl;

  // $scope.signedInPicture = function () {
  //     return "/img/avatar/blank.png";
  // }

  $scope.isLoggedIn = false;
  // $scope.usrProfilePicture =  "";
  //
  // $scope.login = function() {
  //   // $location.path("/login");
  //   $facebook.login(function() {
  //   }).then(function(message) {
  //     $scope.isLoggedIn = true;
  //     console.log("Logged in through facebook.");
  //     refresh();
  //   });
  // }
  //
  // $scope.logout = function() {
  //   $facebook.logout().then(function() {
  //     $scope.isLoggedIn = false;
  //     refresh();
  //   });
  // }
  //
  // function fetchProfilePic(userid) {
  //   $facebook.api("/" + userid + "/picture?type=large").then(
  //     function(response) {
  //       console.log(response.data.url);
  //       $scope.url = response.data.url;
  //       $scope.isLoggedIn = true;
  //     },
  //     function(err) {
  //       console.log("Could not fetch profile picture.");
  //     });
  // }

  // function refresh () {
  //   $facebook.api("/me").then(
  //     function(response) {
  //       // $scope.welcomeMsg = "Welcome, " + response.name;
  //       // console.log(response);
  //       fetchProfilePic(response.id);
  //       $scope.usrName = response.name;
  //       $scope.isLoggedIn = true;
  //     },
  //     function(err) {
  //       $scope.url = "/img/avatar/blank.png";
  //       // $scope.welcomeMsg = "Please log in ...";
  //     });
  //     // console.log("Hello");
  // }


  // function fetchProfilePic(userid) {
  //   $facebook.api("/" + userid + "/picture?type=large").then(
  //     function(response) {
  //       $scope.usrProfilePicture = response.data.url;
  //       $scope.isLoggedIn = true;
  //     },
  //     function(err) {
  //       console.log("Could not fetch profile picture.");
  //     });
  // }
  //
  // $scope.refresh = function () {
  //   $facebook.api("/me").then(
  //     function(response) {
  //       $scope.welcomeMsg = "Welcome " + response.name;
  //       $scope.isLoggedIn = true;
  //     },
  //     function(err) {
  //       $scope.welcomeMsg = "Checking if logged in ...";
  //     });
  // }


      // if ($scope.isLoggedIn == true) {
      //   $scope.url = "/img/avatar/ava-1.png";
      //   console.log("I made the change");
      // }

    //   $scope.$watch('url', function() {
    //     alert('hey, myVar has changed!');
  //   // });
  // }
  //
  // $scope.login;
  // refresh();
}]);

app.controller('ClickRatingsController', ['$scope', function ClickRatingsController($scope) {
  $scope.showCurrentRating = function (numRating) {
    var thisManyStars = $scope.showThisManyStars(numRating);
    return thisManyStars;
  }

  $scope.currentRating = 0;
  $scope.lastClicked = 1;

  $scope.clickedStars = function (thisClicked) {
    if ($scope.lastClicked == thisClicked) {
      $scope.lastClicked = thisClicked;
      $scope.currentRating = $scope.currentRating +1;

      if ($scope.currentRating > 5) {
        $scope.currentRating = 0;
      }
    } else {
      $scope.lastClicked = thisClicked;
      $scope.currentRating = thisClicked;
    }
  };

  $scope.showStars = function (thisIndex) {
    for (var i = 1; i <= 5; i++) {
      if (thisIndex <= $scope.currentRating) {
        return  "★";
      } else {
        return  "☆";
      }
    }
  };

  $scope.showThisManyStars = function (num) {
    var stars = "";
    var num = Math.round(num);

    for (var i = 0; i < num; i++) {
      stars += "★";
    };

    for (var i = 0; i < (5-num); i++) {
      stars += "☆";
    };

    return stars;
  };
}]);

// Define Login Controller
app.controller('LoginController', ['$scope', '$facebook', 'hexafy', function ($scope, $facebook, hexafy) {
  $scope.socialLogoUrl = "img/facebook.png";
  $scope.getCurrentUser = hexafy.getUserName;
  $scope.getUrl = hexafy.getUrl;
  $scope.getLoggedIn = hexafy.getSignedIn;

  $scope.login = function() {
    $facebook.login().then(function() {
      hexafy.signIn();
      $scope.refresh();
    });
  }

  $scope.logout = function() {
    // $scope.isLoggedIn = false;
    // $scope.welcomeMsg = "Please log in ...";
    // $scope.usrProfilePicture = "";
    hexafy.signOut();
    // $facebook.logout().then(function() {
    //   $scope.refresh();
    // });
  }

  function fetchProfilePic(userid) {
    $facebook.api("/" + userid + "/picture?type=large").then(
      function(response) {
        $scope.usrProfilePicture = response.data.url;
        $scope.changeUrl(response.data.url);
        $scope.isLoggedIn = true;
      },
      function(err) {
        console.log("Could not fetch profile picture.");
      });
  }

  $scope.refresh = function () {
    $facebook.api("/me").then(
      function(response) {
        $scope.welcomeMsg = "Welcome, " + response.name;
        console.log("Bird 123 " + response.name);
        console.log(hexafy.getUserName());
        hexafy.setUserName(response.name);
        console.log(hexafy.getUserName());
        fetchProfilePic(response.id);
        $scope.isLoggedIn = true;
      },
      function(err) {
        $scope.welcomeMsg = "Please log in ...";
      });
  }

  $scope.changeUrl = function (input) {
    return hexafy.changeUrl(input);
  }

  $scope.refresh();
}]);

// Define RestrController
app.controller('RestrController', ['$scope', '$routeParams', 'message', 'hexafy', '$facebook', function RestrController($scope, $routeParams, message, hexafy, $facebook) {
  $scope.restaurants = message;

  $scope.isSignedIn = hexafy.getSignedIn;
  // console.log($scope.restaurants);

  $scope.getAvatar = hexafy.getUrl;

  $scope.login = function() {
    $facebook.login().then(function() {
      hexafy.signIn();
      $scope.refresh();
    });
  }

  function fetchProfilePic(userid) {
    $facebook.api("/" + userid + "/picture?type=large").then(
      function(response) {
        $scope.usrProfilePicture = response.data.url;
        $scope.changeUrl(response.data.url);
        $scope.isLoggedIn = true;
      },
      function(err) {
        console.log("Could not fetch profile picture.");
      });
  }

  $scope.myFunction = function () {
    alert("Say bloo");
  }

  $scope.refresh = function () {
    $facebook.api("/me").then(
      function(response) {
        $scope.welcomeMsg = "Welcome, " + response.name;
        console.log("Bird 123 " + response.name);
        console.log(hexafy.getUserName());
        hexafy.setUserName(response.name);
        console.log(hexafy.getUserName());
        fetchProfilePic(response.id);
        $scope.isLoggedIn = true;
      },
      function(err) {
        $scope.welcomeMsg = "Please log in ...";
      });
  }

  $scope.changeUrl = function (input) {
    return hexafy.changeUrl(input);
  }

  for (var i = 0; i < $scope.restaurants.length; i++) {
    // console.log($scope.restaurants[i].name);
  };

  $scope.bird = "Nerd";
  $scope.sayHello = function () {
    // alert("Hello, world!");
    console.log("You clicked me");
    return "Bird";
  }

  $scope.page = $routeParams;

  $scope.myReview = "Write a review...";

  $scope.addLikes = function (restID) {
    var thisRest = this.restaurants[restID];
    console.log(thisRest.liked);
    // thisRest.likes=100;

    if (thisRest.liked == false) {
        thisRest.likes++;
        thisRest.liked = true;
        this
    }
  };

  $scope.currentUser = hexafy.getUserName;

  $scope.currentRating = 0;

  $scope.showReviewStars = function (num) {
    var stars = "";
    var num = Math.round(num);

    for (var i = 0; i < num; i++) {
      stars += "★";
    };

    for (var i = 0; i < (5-num); i++) {
      stars += "☆";
    };

    return stars;
  };

  $scope.updateAvgRatings = function () {
    for (var i = 0; i < $scope.restaurants.length; i++) {
      var thisRestRating;
      var currentSum = 0;
      for (var t = 0; t < $scope.restaurants[i].reviews.length; t++) {
        currentSum = currentSum + $scope.restaurants[i].reviews[t].rating;
      }

      thisRestRating = currentSum / $scope.restaurants[i].reviews.length;
      $scope.restaurants[i].rating = parseFloat(thisRestRating).toFixed(1);
    }
  }

  $scope.writeReview = function  (restID) {
    var thisRest = this.restaurants[restID];

    if (thisRest.reviewed == false) {
      thisRest.reviews.push(
        {
          author: $scope.currentUser(),
          rating: $scope.currentRating,
          img: $scope.getAvatar(),
          dateposted: "2 minutes ago",
          review: $scope.myReview
        }
      );

      $scope.currentRating = 0;
      thisRest.reviewed = true;
      $scope.updateAvgRatings();
    }

    // alert("Thank you for the review!");
  };

  $scope.getRestID = function (name) {
    var thisID;

    for (var i = 0; i < $scope.restaurants.length; i++) {
      if (name == $scope.restaurants[i].link) {
        thisID = i;
      }
    };

    return thisID;
  }

  var init = function () {
   $scope.updateAvgRatings();
  };

  init();
}]);

// Config file

app.config( function( $facebookProvider ) {
  $facebookProvider.setAppId('413105435480517');
})

// Routes file
app.config(function($routeProvider) {
    $routeProvider
    .when("/", {
        templateUrl : "templates/main.html",
        controller : "RestrController",
        resolve: {
            'message': function($http){
            return $http.get('https://restaurantor-26d08.firebaseio.com/.json')
            .then(function(response){
              // console.log(response.data);
              return response.data;
            });
          }
        }
    })
    // .when("/login", {
    //     templateUrl : "templates/login.html",
    //     controller: "LoginController"
    // })
    // .when("/logout", {
    //     templateUrl : "templates/main.html",
    //     controller : "RestrController",
    //     resolve: {
    //         'message': function($http){
    //         return $http.get('https://restaurantor-26d08.firebaseio.com/.json')
    //         .then(function(response){
    //           return response.data;
    //         });
    //       }
    //     }
    // })
    .when("/:pagename", {
        templateUrl : "templates/item.html",
        controller : "RestrController",
        resolve: {
            'message': function($http){
            return $http.get('https://restaurantor-26d08.firebaseio.com/.json')
            .then(function(response){
              return response.data;
            });
          }
        }
    });
});

app.directive("w3TestDirective", function() {
    return {
        templateUrl: "/templates/directives/clickRatingsDirective.html",
        controller : "ClickRatingsController"
    };
});

app.directive("navBar", function() {
    return {
        templateUrl: "templates/directives/navBarDirective.html"
    };
});

// Define Hexafy
app.service('hexafy', function() {
  // var myServiceVal = "Bird";
  // var myUrl = "/img/avatar/blank.png";
  // var isSignedIn = "Blue";
  var service = {
    myUrl: "img/avatar/blank.png",
    myUserName: "123",
    isSignedIn: false,
    getUrl: function () {
      return service.myUrl;
    },
    getUserName: function () {
      return service.myUserName;
    },
    setUserName: function (input) {
      service.myUserName = input;
    },
    changeUrl: function (input) {
      service.myUrl = input;
    },
    getSignedIn: function () {
      return service.isSignedIn;
    },
    signIn: function () {
      service.isSignedIn = true;
    },
    signOut: function () {
      service.isSignedIn = false;
      console.log("You've signed out!");
      service.myUrl = "img/avatar/blank.png";
    }
  };
  //
  // this.isSignedInFunc = function () {
  //   return isSignedIn;
  // };

  // this.signIn = function () {
  //   isSignedIn = true;
  // }
  //
  // this.signOut = function () {
  //   isSignedIn = false;
  // }

  //
  // // this.getAvatar = function () {
  // //   return myUrl;
  // // }
  // //
  // // this.returnVal = function() {
  // //   return myServiceVal;
  // // }
  // //
  // // this.showVal = function() {
  // //   console.log(myServiceVal);
  // // }
  // //
  // service.changeServiceVal = function () {
  //   // myServiceVal += " is the word.";
  //   console.log("Hello");
  //   console.log(service.foo);
  //   service.foo = "I've just changed";
  // }
  //
  // this.sayHello = function () {
  //   console.log('hello');
  //   myUrl = "/img/avatar/ava-2.png";
  //   console.log(myUrl);
  // };

  return service;
});

// Define Hexafy
app.service('restaurantListService', function() {
  // var myServiceVal = "Bird";
  var myUrl = "/img/avatar/blank.png";


  this.getUrl = function () {
    return myUrl;
  }

  this.changeUrl = function (input) {
    myUrl = input;
    // console.log("Url changed");
  }
});
